<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>عرض المسارات على الخريطة</title>
    <!-- تحميل مكتبة Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <!-- تحميل مكتبة Leaflet Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

    <!-- تحميل مكتبة Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // تهيئة Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAYP_0YecYNCgoTKyvuSme9u3pmg-CH1iU",
            authDomain: "korsa-01.firebaseapp.com",
            projectId: "korsa-01",
            storageBucket: "korsa-01.firebasestorage.app",
            messagingSenderId: "240468092018",
            appId: "1:240468092018:web:641db8b472b2c7da0aceeb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let userLat = 32.8872; // الافتراضي - طرابلس
        let userLng = 13.1910;
        let currentLocationMarker; // متغير لحفظ المؤشر الحالي

        // إنشاء الخريطة
        const map = L.map('map').setView([userLat, userLng], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // تحديث الموقع الحالي
        function updateLocation(lat, lng) {
            userLat = lat;
            userLng = lng;

            // تحديث العلامة
            if (currentLocationMarker) {
                map.removeLayer(currentLocationMarker);
            }
            currentLocationMarker = L.marker([lat, lng]).addTo(map)
                .bindPopup("الموقع الحالي")
                .openPopup();

            // تحديث الحقول
            document.getElementById("input-lat").value = lat.toFixed(6);
            document.getElementById("input-lng").value = lng.toFixed(6);
        }

        // تحقق دوري من الحقول
        setInterval(() => {
            const latField = document.getElementById("input-lat").value;
            const lngField = document.getElementById("input-lng").value;

            const newLat = parseFloat(latField);
            const newLng = parseFloat(lngField);

            if (!isNaN(newLat) && !isNaN(newLng) && (newLat !== userLat || newLng !== userLng)) {
                updateLocation(newLat, newLng);
            }
        }, 5000); // التحقق كل 5 ثوانٍ

        // وظيفة لتحريك الخريطة إلى الموقع الحالي
        function moveToCurrentLocation() {
            if (currentLocationMarker) {
                map.setView([userLat, userLng], 14); // تكبير الخريطة إلى الموقع الحالي
                currentLocationMarker.openPopup();
            }
        }

        // مراقبة التغيرات في مجموعة "الطلابات"
        function monitorRoutes() {
            const routesRef = collection(db, "الطلابات");
            onSnapshot(routesRef, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const doc = change.doc;
                    const routeData = doc.data();
                    const routeId = doc.id;

                    if (change.type === "added") {
                        addRouteMarker(routeId, routeData);
                    } else if (change.type === "modified") {
                        updateRouteMarker(routeId, routeData);
                    } else if (change.type === "removed") {
                        removeRouteMarker(routeId);
                    }
                });
            });
        }

        // وظائف العلامات والمسارات
        let markers = {}; // لتخزين علامات نقاط البداية والوجهة حسب ID

        function addRouteMarker(routeId, routeData) {
            const startLat = routeData.startPoint.lat;
            const startLng = routeData.startPoint.lng;

            const startMarker = L.marker([startLat, startLng]).addTo(map)
                .bindPopup(`نقطة البداية: ${startLat}, ${startLng}`);

            markers[routeId] = { startMarker };
        }

        function updateRouteMarker(routeId, routeData) {
            removeRouteMarker(routeId);
            addRouteMarker(routeId, routeData);
        }

        function removeRouteMarker(routeId) {
            if (markers[routeId]) {
                map.removeLayer(markers[routeId].startMarker);
                delete markers[routeId];
            }
        }

        monitorRoutes();
    </script>
    <style>
        body {
            display: flex;
            flex-direction: row;
            margin: 0;
            font-family: Arial, sans-serif;
        }
        #map-container {
            flex: 1;
            height: 100vh;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        #info-container {
            flex: 1;
            padding: 20px;
            background: #f4f4f4;
            overflow-y: auto;
        }
        .info-input {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }
        .info-input input {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .info-input input[readonly] {
            background-color: #e9e9e9;
            cursor: not-allowed;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div id="map-container">
        <div id="map"></div>
    </div>
    <div id="info-container">
        <div class="info-input">
            <label for="input-lat">Latitude:</label>
            <input type="text" id="input-lat" readonly>
        </div>
        <div class="info-input">
            <label for="input-lng">Longitude:</label>
            <input type="text" id="input-lng" readonly>
        </div>
        <button onclick="moveToCurrentLocation()">تحريك الخريطة إلى الموقع الحالي</button>
    </div>
</body>
</html>
